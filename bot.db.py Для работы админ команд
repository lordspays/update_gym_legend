# Добавьте эти функции в bot/db.py

async def set_info_access(user_id: int, days: int, admin_id: int) -> bool:
    """Выдать игроку доступ к команде /инфа на определенный срок"""
    async with pool.acquire() as conn:
        expires_at = (datetime.now() + timedelta(days=days)).isoformat()
        await conn.execute("""
            INSERT OR REPLACE INTO info_access 
            (user_id, admin_id, granted_at, expires_at) 
            VALUES (?, ?, datetime('now'), ?)
        """, (user_id, admin_id, expires_at))
        return True


async def remove_info_access(user_id: int, admin_id: int) -> bool:
    """Забрать доступ к команде /инфа у игрока"""
    async with pool.acquire() as conn:
        await conn.execute("""
            DELETE FROM info_access WHERE user_id = ?
        """, (user_id,))
        return True


async def get_info_access_status(user_id: int) -> bool:
    """Проверить, есть ли у игрока действующий доступ к команде /инфа"""
    async with pool.acquire() as conn:
        cursor = await conn.execute("""
            SELECT 1 FROM info_access 
            WHERE user_id = ? AND expires_at > datetime('now')
        """, (user_id,))
        return bool(await cursor.fetchone())


async def get_info_access_details(user_id: int) -> dict:
    """Получить детальную информацию о доступе к команде /инфа"""
    async with pool.acquire() as conn:
        cursor = await conn.execute("""
            SELECT * FROM info_access 
            WHERE user_id = ?
        """, (user_id,))
        row = await cursor.fetchone()
        return dict(row) if row else None


async def get_all_info_access() -> list:
    """Получить список всех игроков с доступом к команде /инфа"""
    async with pool.acquire() as conn:
        cursor = await conn.execute("""
            SELECT * FROM info_access 
            ORDER BY expires_at DESC
        """)
        rows = await cursor.fetchall()
        return [dict(row) for row in rows]


async def extend_info_access(user_id: int, days: int, admin_id: int) -> bool:
    """Продлить доступ к команде /инфа"""
    async with pool.acquire() as conn:
        # Получаем текущую дату истечения
        cursor = await conn.execute("""
            SELECT expires_at FROM info_access WHERE user_id = ?
        """, (user_id,))
        row = await cursor.fetchone()
        
        if row:
            current_expires = datetime.fromisoformat(row["expires_at"])
            new_expires_at = current_expires + timedelta(days=days)
            
            await conn.execute("""
                UPDATE info_access 
                SET expires_at = ?, admin_id = ?
                WHERE user_id = ?
            """, (new_expires_at.isoformat(), admin_id, user_id))
            return True
        return False


async def cleanup_expired_info_access():
    """Очистить истекшие доступы"""
    async with pool.acquire() as conn:
        await conn.execute("""
            DELETE FROM info_access 
            WHERE expires_at <= datetime('now')
        """)
